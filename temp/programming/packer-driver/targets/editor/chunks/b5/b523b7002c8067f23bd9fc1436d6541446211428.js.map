{"version":3,"sources":["file:///D:/cocos_work/games/SimulateCity/assets/src/component/CameraControllerComp.ts"],"names":["_decorator","CameraComponent","Component","Quat","Vec2","Vec3","GlobalConst","v3_1","Msg","MsgEvent","Log","ccclass","property","v2_1","v2_2","qt_1","forward","right","CameraControllerComp","slide","range","_camera","_velocity","_position","_speedScale","distanceY","_rotation","onLoad","ins","camera","node","getComponentInChildren","copy","getPosition","rotation","onEnable","on","OP_TOUCH_SCALE","scaleView","bind","onDisable","off","OP_TOUCH_MOVE","OP_TOUCH_ROTA","start","moveView","vec2","console","log","x","y","scale","multiplyScalar","set","moveView2","test","speed","Math","abs","transformQuat","UNIT_Z","scaleAndAdd","position","rotaView","rotateAround","update","dt","t","min","damp","moveSpeed","lerp","setPosition","moveDir","cameraMoveDir","lengthSqr","FORWARD","normalize","cross","UP","z","slerp"],"mappings":"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","sourcesContent":["import { _decorator, Camera, CameraComponent, Component, director, EventTouch, game, Node, Quat, sp, Vec2, Vec3 } from 'cc';\r\nimport { GlobalConst, v3_1, v3_2 } from '../GlobalConst';\r\nimport { Msg } from '../msg/msg';\r\nimport { MsgEvent } from '../msg/MsgEvent';\r\nimport { Log } from '../framework/Log';\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst v2_1 = new Vec2();\r\nconst v2_2 = new Vec2();\r\n\r\n\r\nconst qt_1 = new Quat();\r\nconst forward = new Vec3();\r\nconst right = new Vec3();\r\n\r\n@ccclass('CameraControllerComp')\r\nexport class CameraControllerComp extends Component {\r\n\r\n    private _camera: CameraComponent;\r\n\r\n    @property\r\n    public moveSpeed = 1;\r\n\r\n    @property\r\n    public moveSpeedShiftScale = 5;\r\n\r\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\r\n    public damp = 0.2;\r\n\r\n    @property\r\n    public rotateSpeed = 1;\r\n\r\n    private _velocity = new Vec3();\r\n    private _position = new Vec3();\r\n    private _speedScale = 1;\r\n\r\n    distanceY: number = 200;\r\n    private _rotation: Quat = new Quat();\r\n\r\n    // 移动  单指\r\n\r\n    // 旋转  双指\r\n    // 缩放\r\n\r\n    // 边界\r\n    // 数据区间\r\n\r\n    // 插值运算\r\n\r\n    protected onLoad(): void {\r\n        CameraControllerComp.ins = this;\r\n        CameraControllerComp.camera = this._camera = this.node.getComponentInChildren(CameraComponent);\r\n        Vec3.copy(this._position, this.node.getPosition());\r\n        Quat.copy(this._rotation,  this._camera.node.rotation);\r\n\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        // Msg.on(MsgEvent.OP_TOUCH_MOVE, this.moveView.bind(this));\r\n        // Msg.on(MsgEvent.OP_TOUCH_ROTA, this.rotaView.bind(this));\r\n        Msg.on(MsgEvent.OP_TOUCH_SCALE, this.scaleView.bind(this));\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        Msg.off(MsgEvent.OP_TOUCH_MOVE);\r\n        Msg.off(MsgEvent.OP_TOUCH_ROTA);\r\n        Msg.off(MsgEvent.OP_TOUCH_SCALE);\r\n    }\r\n\r\n    start() {\r\n\r\n    }\r\n\r\n\r\n    /** 移动 */\r\n    public moveView(vec2:Vec2) {\r\n        console.log(\"转换出来的坐标:vec2 vec2\", vec2.x, vec2.y);\r\n        const scale = 1 + this._position.y / this.distanceY * 10;\r\n        vec2.multiplyScalar(scale);\r\n        this._velocity.set(vec2.x, 0, vec2.y);\r\n        // this._camera.screenToWorld(this._velocity,this._velocity);\r\n        // Vec3.subtract(this._velocity, this._velocity, this._position);\r\n    }\r\n\r\n    /** 移动 */\r\n    public moveView2(vec2:Vec2) {\r\n        console.log(\"转换出来的坐标:vec2 vec2\", vec2.x, vec2.y);\r\n        const scale = 1 + this._position.y / this.distanceY * 10;\r\n        vec2.multiplyScalar(scale);\r\n        this._velocity.set(vec2.x, 0, vec2.y);\r\n        // this._camera.screenToWorld(this._velocity,this._velocity);\r\n        // Vec3.subtract(this._velocity, this._velocity, this._position);\r\n    }\r\n\r\n    public static ins:CameraControllerComp;\r\n    public static camera:Camera;\r\n    public static test(vec2:Vec2){\r\n\r\n        // console.log(\"转换出来的坐标:vec2 vec2\", vec2.x, vec2.y);\r\n        // v3_2.set(vec2.x, vec2.y, 0);\r\n        // this.ins._camera.screenToWorld(v3_2,v3_1);\r\n        // console.log(\"转换出来的坐标:\", v3_1.x, v3_1.y, v3_1.z);\r\n    }\r\n\r\n    /** 缩放 */\r\n    public scaleView(speed: number) {\r\n        Log.log(\"scaleView -- speed:\"+speed);\r\n        if(Math.abs(this._position.y + speed) < this.distanceY){\r\n            Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this._camera.node.rotation);\r\n            Vec3.scaleAndAdd(this._position, this.node.position, v3_1, speed);\r\n        }\r\n    }\r\n\r\n    /** 旋转 */\r\n    public rotaView(vec2: Vec2) { // 旋转看着像是地图的旋转\r\n        \r\n        let x = vec2.x;\r\n        let y = vec2.y;\r\n        \r\n        Quat.rotateAround(this._rotation, this._rotation, this._camera.node.forward, y);\r\n        Quat.rotateAround(this._rotation, this._rotation, this._camera.node.right, x);\r\n\r\n        // if (this._eulerP.x + x < -30 && this._eulerP.x + x > -90) { // x处角度的旋转限制 测试使用\r\n        //     this._eulerP.x += x;\r\n        // }\r\n        // this._eulerP.y += y;\r\n    }\r\n\r\n    public update(dt: number) {\r\n        const t = Math.min(dt / this.damp, 1);\r\n        // position\r\n        Vec3.transformQuat(v3_1, this._velocity, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this._position, v3_1, this.moveSpeed * this._speedScale);\r\n        Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n        this.node.setPosition(v3_1);\r\n        const moveDir = GlobalConst.cameraMoveDir;\r\n        if (moveDir.lengthSqr()) {\r\n            Vec3.transformQuat(forward, Vec3.FORWARD, this.node.rotation);\r\n            forward.normalize();\r\n            Vec3.cross(right, forward, Vec3.UP);\r\n            right.normalize();\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, forward, this.moveSpeed * this._speedScale * moveDir.z);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, right, this.moveSpeed * this._speedScale * moveDir.x);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, Vec3.UP, this.moveSpeed * this._speedScale * moveDir.y);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n        }\r\n\r\n        // rotation\r\n        Quat.slerp(qt_1, this._camera.node.rotation, this._rotation, t);\r\n        this._camera.node.rotation = qt_1;\r\n        this._velocity.set();\r\n    }\r\n}\r\n\r\n\r\n"]}