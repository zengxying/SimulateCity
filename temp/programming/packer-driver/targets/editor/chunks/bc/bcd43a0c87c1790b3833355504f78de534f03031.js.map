{"version":3,"sources":["file:///D:/cocos_work/games/SimulateCity/assets/src/component/FreeCamera.ts"],"names":["_decorator","Component","Quat","Vec2","Vec3","Input","game","input","KeyCode","v2","ccclass","property","v2_1","v2_2","v3_1","qt_1","forward","right","FreeCamera","slide","range","_euler","_velocity","_position","_speedScale","_eulerP","keys","moveDir","key2dirMap","onLoad","on","EventType","MOUSE_WHEEL","onMouseWheel","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","copy","node","eulerAngles","getPosition","KEY_DOWN","onKeyDown","KEY_UP","onKeyUp","onDestroy","off","update","dt","t","Math","min","damp","transformQuat","rotation","scaleAndAdd","moveSpeed","lerp","setPosition","lengthSqr","FORWARD","normalize","cross","UP","z","x","y","fromEuler","slerp","setWorldRotationFromEuler","e","delta","getScrollY","UNIT_Z","position","canvas","requestPointerLock","getStartLocation","console","log","width","getDelta","rotateSpeed","document","exitPointerLock","event","keyCode","KEY_A","KEY_S","KEY_D","KEY_W","indexOf","push","updateDirection","KEY_Q","KEY_E","index","splice","keyCode0","length","keyCode1","dir"],"mappings":"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","sourcesContent":["import { _decorator, Component, Quat, Vec2, Vec3, Input, game, EventTouch, EventMouse, input, EventKeyboard, KeyCode, v2 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst v2_1 = new Vec2();\r\nconst v2_2 = new Vec2();\r\nconst v3_1 = new Vec3();\r\nconst qt_1 = new Quat();\r\nconst forward = new Vec3();\r\nconst right = new Vec3();\r\n\r\n@ccclass('tgxFreeCamera')\r\nexport class FreeCamera extends Component {\r\n\r\n    @property\r\n    public moveSpeed = 1;\r\n\r\n    @property\r\n    public moveSpeedShiftScale = 5;\r\n\r\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\r\n    public damp = 0.2;\r\n\r\n    @property\r\n    public rotateSpeed = 1;\r\n\r\n    private _euler = new Vec3();\r\n    private _velocity = new Vec3();\r\n    private _position = new Vec3();\r\n    private _speedScale = 1;\r\n    private _eulerP = new Vec3();\r\n\r\n    public onLoad () {\r\n        input.on(Input.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        input.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        input.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        input.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        Vec3.copy(this._euler, this.node.eulerAngles);\r\n        Vec3.copy(this._position, this.node.getPosition());\r\n        Vec3.copy(this._eulerP, this.node.eulerAngles);\r\n\r\n        input.on(Input.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        input.on(Input.EventType.KEY_UP, this.onKeyUp, this);\r\n    }\r\n\r\n    public onDestroy () {\r\n        input.off(Input.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        input.off(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        input.off(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        input.off(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n\r\n        input.off(Input.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        input.off(Input.EventType.KEY_UP, this.onKeyUp, this);\r\n    }\r\n\r\n\r\n    public update (dt: number) {\r\n        const t = Math.min(dt / this.damp, 1);\r\n        // position\r\n        Vec3.transformQuat(v3_1, this._velocity, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this._position, v3_1, this.moveSpeed * this._speedScale);\r\n        Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n        this.node.setPosition(v3_1);\r\n\r\n        if(this.moveDir.lengthSqr()){\r\n            Vec3.transformQuat(forward, Vec3.FORWARD, this.node.rotation);\r\n            forward.normalize();\r\n            Vec3.cross(right, forward, Vec3.UP);\r\n            right.normalize();\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, forward, this.moveSpeed * this._speedScale * this.moveDir.z);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, right, this.moveSpeed * this._speedScale * this.moveDir.x);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, Vec3.UP, this.moveSpeed * this._speedScale * this.moveDir.y);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n        }\r\n\r\n        // rotation\r\n        Quat.fromEuler(qt_1, this._eulerP.x, this._eulerP.y, this._eulerP.z);\r\n        Quat.slerp(qt_1, this.node.rotation, qt_1, t);\r\n        this.node.setWorldRotationFromEuler(this._eulerP.x, this._eulerP.y, this._eulerP.z);\r\n    }\r\n\r\n    public onMouseWheel (e: EventMouse) {\r\n        const delta = -e.getScrollY() * this.moveSpeed * 0.1; // delta is positive when scroll down\r\n        Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this.node.position, v3_1, delta);\r\n    }\r\n    \r\n    public onTouchStart (e: EventTouch) {\r\n        if (game.canvas.requestPointerLock) { game.canvas.requestPointerLock(); }\r\n    }\r\n\r\n    public onTouchMove (e: EventTouch) {\r\n        e.getStartLocation(v2_1);\r\n        console.log(`v2_1.x > game.canvas.width * 0.4  ${v2_1.x} > ${game.canvas.width * 0.4}`)\r\n        if (v2_1.x > game.canvas.width * 0.4) { // rotation\r\n            e.getDelta(v2_2);\r\n            this._eulerP.y -= v2_2.x * this.rotateSpeed * 0.1;\r\n            this._eulerP.x += v2_2.y * this.rotateSpeed * 0.1;\r\n        } else { // position\r\n            e.getDelta(v2_2);\r\n            this._eulerP.y -= v2_2.x * this.rotateSpeed * 0.1;\r\n            this._eulerP.x += v2_2.y * this.rotateSpeed * 0.1;\r\n        }\r\n    }\r\n\r\n    public onTouchEnd (e: EventTouch) {\r\n        if (document.exitPointerLock) { document.exitPointerLock(); }\r\n        e.getStartLocation(v2_1);\r\n        if (v2_1.x < game.canvas.width * 0.4) { // position\r\n            this._velocity.x = 0;\r\n            this._velocity.z = 0;\r\n        }\r\n    }\r\n\r\n    private keys = [];\r\n    // x  -1 left, +1 right   y -1 backword, +1 forward\r\n    private moveDir:Vec3 = new Vec3();\r\n    onKeyDown(event:EventKeyboard){\r\n        let keyCode = event.keyCode;\r\n        if(keyCode == KeyCode.KEY_A || keyCode == KeyCode.KEY_S || keyCode == KeyCode.KEY_D || keyCode == KeyCode.KEY_W){\r\n            if(this.keys.indexOf(keyCode) == -1){\r\n                this.keys.push(keyCode);\r\n                this.updateDirection();\r\n            }\r\n        }\r\n        if(keyCode == KeyCode.KEY_Q){\r\n            this.moveDir.y = -1;\r\n        }\r\n        else if(keyCode == KeyCode.KEY_E){\r\n            this.moveDir.y = 1;\r\n        }\r\n    }\r\n\r\n    onKeyUp(event:EventKeyboard){\r\n        let keyCode = event.keyCode;\r\n        if(keyCode == KeyCode.KEY_A || keyCode == KeyCode.KEY_S || keyCode == KeyCode.KEY_D || keyCode == KeyCode.KEY_W){\r\n            let index = this.keys.indexOf(keyCode);\r\n            if(index != -1){\r\n                this.keys.splice(index,1);\r\n                this.updateDirection();\r\n            }\r\n        }\r\n\r\n        if(keyCode == KeyCode.KEY_Q || keyCode == KeyCode.KEY_E){\r\n            this.moveDir.y = 0;\r\n        }\r\n    }\r\n\r\n    private key2dirMap = null;\r\n\r\n    updateDirection(){\r\n        if(this.key2dirMap == null){\r\n            this.key2dirMap = {};\r\n            this.key2dirMap[0] = v2(0,0);\r\n            this.key2dirMap[KeyCode.KEY_A] = v2(-1,0);\r\n            this.key2dirMap[KeyCode.KEY_D] = v2(1,0);\r\n            this.key2dirMap[KeyCode.KEY_W] = v2(0,1);\r\n            this.key2dirMap[KeyCode.KEY_S] = v2(0,-1);\r\n\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_A] = v2(-1,1);\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_D] = v2(1,1);\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_A] = v2(-1,-1);\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_D] = v2(1,-1);\r\n\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_D] = this.key2dirMap[KeyCode.KEY_D];\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_A] = this.key2dirMap[KeyCode.KEY_A];\r\n            this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S];\r\n            this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W];\r\n        }\r\n        let keyCode0 = this.keys[this.keys.length - 1] || 0;\r\n        let keyCode1 = this.keys[this.keys.length - 2] || 0;\r\n        let dir = this.key2dirMap[keyCode1 * 1000 + keyCode0];\r\n        this.moveDir.x = dir.x;\r\n        this.moveDir.z = dir.y;\r\n    }\r\n}\r\n"]}