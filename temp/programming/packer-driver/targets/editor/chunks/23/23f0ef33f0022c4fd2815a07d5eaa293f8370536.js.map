{"version":3,"sources":["file:///D:/cocos_work/SimulateCity/assets/src/operate/BuildingOperateLogic.ts"],"names":["BuildingOperateLogic","Vec2","GlobalConst","v2_1","v3_1","BuildingOperateState","constructor","comp","target","_longTouchTime","_state","NONE","_startTouchPoint","_comp","onTouchStart","e","interruptBuildingOp","console","warn","touches","getAllTouches","_isSinglePoint","scheduleOnce","onLongTouch","bind","LONG_TOUCH_CHECK","getLocation","LONG_TOUCH_RUNNING","mapPanel","getHitPointToGridPosition","setPosition","log","length","checkMoveBuild","onTouchMove","getDelta","lengthSqr","unschedule","SHORT_TOUCH_RUNNING","onTouchEnd"],"mappings":"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","sourcesContent":["import { _decorator, Component, Quat, Vec2, Vec3, Input, game, EventTouch, Node } from 'cc';\r\nimport { GlobalConst, v2_1, v2_2, v3_1, v3_2 } from '../GlobalConst';\r\nimport { MsgEvent } from '../msg/MsgEvent';\r\nimport { Msg } from '../msg/msg';\r\nimport { IOperateHandler } from './IOperateLogic';\r\n\r\nenum BuildingOperateState {\r\n    NONE,\r\n    LONG_TOUCH_CHECK,\r\n    LONG_TOUCH_RUNNING,\r\n    SHORT_TOUCH_RUNNING,\r\n}\r\n\r\nexport class BuildingOperateLogic implements IOperateHandler {\r\n\r\n    private target: Node;\r\n    private _longTouchTime: number = 1;\r\n\r\n    private _state: BuildingOperateState = BuildingOperateState.NONE;\r\n    private _startTouchPoint: Vec2 = new Vec2();\r\n\r\n    _comp:Component;\r\n    constructor(comp:Component){\r\n        this._comp = comp;\r\n    }\r\n\r\n\r\n    public onTouchStart(e: EventTouch) {\r\n        if (GlobalConst.interruptBuildingOp) return console.warn(\"中断操作中...............\");\r\n        // if (game.canvas.requestPointerLock) { game.canvas.requestPointerLock(); }\r\n        const touches = e.getAllTouches();\r\n        if (this._isSinglePoint(e)) {\r\n            this._comp.scheduleOnce(this.onLongTouch.bind(this), this._longTouchTime);\r\n            this._state = BuildingOperateState.LONG_TOUCH_CHECK;\r\n            touches[0].getLocation(this._startTouchPoint);\r\n        }\r\n    }\r\n\r\n    onLongTouch() {\r\n        // 进入了拖动建筑物流程\r\n        this._state = BuildingOperateState.LONG_TOUCH_RUNNING;\r\n        GlobalConst.mapPanel.getHitPointToGridPosition(this._startTouchPoint, v3_1);\r\n        this.target.setPosition(v3_1);\r\n        console.log(\"长按中....................\");\r\n    }\r\n\r\n    private _isSinglePoint(e: EventTouch) {\r\n        return e.getAllTouches().length <= 1;\r\n    }\r\n\r\n    public checkMoveBuild() :boolean{\r\n        return this._state == BuildingOperateState.LONG_TOUCH_RUNNING;\r\n    }\r\n\r\n    public onTouchMove(e: EventTouch) {\r\n        if (GlobalConst.interruptBuildingOp) return console.warn(\"中断操作中...............\");\r\n        const touches = e.getAllTouches();\r\n        if (this._isSinglePoint(e)) {\r\n\r\n            e.getDelta(v2_1);\r\n            if (this._state == BuildingOperateState.LONG_TOUCH_CHECK && v2_1.lengthSqr() > 100) {\r\n                this._state = BuildingOperateState.NONE;\r\n                this._comp.unschedule(this.onLongTouch.bind(this));\r\n            }\r\n            if (this._state == BuildingOperateState.LONG_TOUCH_RUNNING) {\r\n                touches[0]\r\n                GlobalConst.mapPanel.getHitPointToGridPosition(this._startTouchPoint, v3_1);\r\n                this.target.setPosition(v3_1);\r\n            }\r\n            if (this._state == BuildingOperateState.SHORT_TOUCH_RUNNING) {\r\n\r\n            }\r\n        }\r\n    }\r\n\r\n    public onTouchEnd(e: EventTouch) {\r\n        this._state = BuildingOperateState.NONE;\r\n        if (GlobalConst.interruptBuildingOp) return console.warn(\"中断操作中...............\");\r\n        \r\n    }\r\n\r\n}"]}