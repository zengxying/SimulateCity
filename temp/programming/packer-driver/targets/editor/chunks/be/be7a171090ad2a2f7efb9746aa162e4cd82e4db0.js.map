{"version":3,"sources":["file:///D:/cocos_work/SimulateCity/assets/src/framework/uiManager.ts"],"names":["_decorator","find","isValid","ResourceUtil","PoolManager","Tips","ccclass","property","SHOW_STR_INTERVAL_TIME","UIManager","_dictSharedPanel","_dictLoading","_arrPopupDialog","_showTipsTime","canvas","instance","_instance","isDialogVisible","panelPath","hasOwnProperty","panel","active","parent","showDialog","args","cb","idxSplit","lastIndexOf","scriptName","slice","script","getComponent","script2","charAt","toUpperCase","show","apply","createUI","err","node","isCloseBeforeShow","console","error","hideDialog","callback","ani","close","pushToPopupSeq","param","popupDialog","isShow","push","_checkPopupSeq","insertToPopupSeq","index","splice","shiftFromPopupSeq","shift","length","first","showTips","content","str","String","next","_showTipsAni","now","Date","spareTime","setTimeout","getUIPrefabRes","prefab","tipsNode","getNode","tipScript"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, find, isValid, Canvas } from \"cc\";\r\nimport { ResourceUtil } from \"./resourceUtil\";\r\nimport { PoolManager } from \"./poolManager\";\r\nimport { Tips } from \"./tips\";\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst SHOW_STR_INTERVAL_TIME = 800;\r\n\r\n@ccclass(\"UIManager\")\r\nexport class UIManager {\r\n    private _dictSharedPanel: any = {};\r\n    private _dictLoading: any = {};\r\n    private _arrPopupDialog: any = [];\r\n    private _showTipsTime: number = 0;\r\n\r\n\r\n    private static _instance: UIManager;\r\n\r\n    public static get instance () {\r\n        if (this._instance) {\r\n            return this._instance;\r\n        }\r\n\r\n        this._instance = new UIManager();\r\n        return this._instance;\r\n    }\r\n\r\n    /**\r\n     * 检查当前界面是否正在展示\r\n     * @param panelPath\r\n     */\r\n    public isDialogVisible (panelPath: string) {\r\n        if (!this._dictSharedPanel.hasOwnProperty(panelPath)) {\r\n            return false;\r\n        }\r\n\r\n        let panel = this._dictSharedPanel[panelPath];\r\n\r\n        return isValid(panel) && panel.active && panel.parent;\r\n    }\r\n\r\n\r\n    /**\r\n     * 显示单例界面\r\n     * @param {String} panelPath\r\n     * @param {Array} args\r\n     * @param {Function} cb 回调函数，创建完毕后回调\r\n     */\r\n    public showDialog (panelPath: string, args?: any, cb?: Function) {\r\n        if (this._dictLoading[panelPath]) {\r\n            return;\r\n        }\r\n\r\n        let idxSplit = panelPath.lastIndexOf('/');\r\n        let scriptName = panelPath.slice(idxSplit + 1);\r\n\r\n\r\n        if (!args) {\r\n            args = [];\r\n        }\r\n\r\n        if (this._dictSharedPanel.hasOwnProperty(panelPath)) {\r\n            let panel = this._dictSharedPanel[panelPath];\r\n            if (isValid(panel)) {\r\n                panel.parent = find(\"Canvas\");\r\n                panel.active = true;\r\n                let script = panel.getComponent(scriptName);\r\n                let script2 = panel.getComponent(scriptName.charAt(0).toUpperCase() + scriptName.slice(1));\r\n\r\n                if (script && script.show) {\r\n                    script.show.apply(script, args);\r\n                    cb && cb(script);\r\n                } else if (script2 && script2.show) {\r\n                    script2.show.apply(script2, args);\r\n                    cb && cb(script2);\r\n                } else {\r\n                    throw `查找不到脚本文件${scriptName}`;\r\n                }\r\n\r\n                return;\r\n            }\r\n        }\r\n\r\n        this._dictLoading[panelPath] = true;\r\n        ResourceUtil.createUI(panelPath, (err: any, node: any) => {\r\n            // 判断是否有可能在显示前已经被关掉了？\r\n            let isCloseBeforeShow = false;\r\n            if (!this._dictLoading[panelPath]) {\r\n                // 已经被关掉\r\n                isCloseBeforeShow = true;\r\n            }\r\n\r\n            this._dictLoading[panelPath] = false;\r\n            if (err) {\r\n                console.error(err);\r\n                return;\r\n            }\r\n\r\n            // node.getComponent(UITransform).priority = Constant.ZORDER.DIALOG;\r\n\r\n            this._dictSharedPanel[panelPath] = node;\r\n\r\n            let script: any = node.getComponent(scriptName);\r\n            let script2: any = node.getComponent(scriptName.charAt(0).toUpperCase() + scriptName.slice(1));\r\n            if (script && script.show) {\r\n                script.show.apply(script, args);\r\n                cb && cb(script);\r\n            } else if (script2 && script2.show) {\r\n                script2.show.apply(script2, args);\r\n                cb && cb(script2);\r\n            } else {\r\n                throw `查找不到脚本文件${scriptName}`;\r\n            }\r\n\r\n            if (isCloseBeforeShow) {\r\n                // 如果在显示前又被关闭，则直接触发关闭掉\r\n                this.hideDialog(panelPath);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 隐藏单例界面\r\n     * @param {String} panelPath\r\n     * @param {fn} callback\r\n     */\r\n    public hideDialog (panelPath: string, callback?: Function) {\r\n        if (this._dictSharedPanel.hasOwnProperty(panelPath)) {\r\n            let panel = this._dictSharedPanel[panelPath];\r\n            if (panel && isValid(panel)) {\r\n                let ani = panel.getComponent('animationUI');\r\n                if (ani) {\r\n                    ani.close(() => {\r\n                        panel.parent = null;\r\n                        if (callback && typeof callback === 'function') {\r\n                            callback();\r\n                        }\r\n                    });\r\n                } else {\r\n                    panel.parent = null;\r\n                    if (callback && typeof callback === 'function') {\r\n                        callback();\r\n                    }\r\n                }\r\n            } else if (callback && typeof callback === 'function') {\r\n                callback();\r\n            }\r\n        }\r\n\r\n        this._dictLoading[panelPath] = false;\r\n    }\r\n\r\n    /**\r\n     * 将弹窗加入弹出窗队列\r\n     * @param {string} panelPath\r\n     * @param {string} scriptName\r\n     * @param {*} param\r\n     */\r\n    public pushToPopupSeq (panelPath: string, scriptName: string, param: any) {\r\n        let popupDialog = {\r\n            panelPath: panelPath,\r\n            scriptName: scriptName,\r\n            param: param,\r\n            isShow: false\r\n        };\r\n\r\n        this._arrPopupDialog.push(popupDialog);\r\n\r\n        this._checkPopupSeq();\r\n    }\r\n\r\n    /**\r\n     * 将弹窗加入弹出窗队列\r\n     * @param {number} index\r\n     * @param {string} panelPath\r\n     * @param {string} scriptName\r\n     * @param {*} param\r\n     */\r\n    public insertToPopupSeq (index: number, panelPath: string, param: any) {\r\n        let popupDialog = {\r\n            panelPath: panelPath,\r\n            param: param,\r\n            isShow: false\r\n        };\r\n\r\n        this._arrPopupDialog.splice(index, 0, popupDialog);\r\n        // this._checkPopupSeq();\r\n    }\r\n\r\n    /**\r\n     * 将弹窗从弹出窗队列中移除\r\n     * @param {string} panelPath\r\n     */\r\n    public shiftFromPopupSeq (panelPath: string) {\r\n        this.hideDialog(panelPath, () => {\r\n            if (this._arrPopupDialog[0] && this._arrPopupDialog[0].panelPath === panelPath) {\r\n                this._arrPopupDialog.shift();\r\n                this._checkPopupSeq();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 检查当前是否需要弹窗\r\n     */\r\n    private _checkPopupSeq () {\r\n        if (this._arrPopupDialog.length > 0) {\r\n            let first = this._arrPopupDialog[0];\r\n\r\n            if (!first.isShow) {\r\n                this.showDialog(first.panelPath, first.param);\r\n                this._arrPopupDialog[0].isShow = true;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 显示提示\r\n     * @param {String} content\r\n     * @param {Function} cb\r\n     */\r\n    public showTips (content: string | number, callback?: Function) {\r\n        let str = String(content);\r\n        let next = () => {\r\n            this._showTipsAni(str, callback);\r\n        };\r\n\r\n        let now = Date.now();\r\n        if (now - this._showTipsTime < SHOW_STR_INTERVAL_TIME) {\r\n            let spareTime = SHOW_STR_INTERVAL_TIME - (now - this._showTipsTime);\r\n            setTimeout(() => {\r\n                next();\r\n            }, spareTime);\r\n\r\n            this._showTipsTime = now + spareTime;\r\n        } else {\r\n            next();\r\n            this._showTipsTime = now;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 内部函数\r\n     * @param {String} content\r\n     * @param {Function} cb\r\n     */\r\n    private _showTipsAni (content: string, callback?: Function) {\r\n        ResourceUtil.getUIPrefabRes('TipsItem', (err: any, prefab: any)=> {\r\n            if (err) {\r\n                return;\r\n            }\r\n\r\n            let tipsNode = PoolManager.instance.getNode(prefab, this.canvas || find(\"Canvas\") as Node);\r\n\r\n            let tipScript = tipsNode.getComponent(Tips) as Tips;\r\n            tipScript.show(content, callback);\r\n        });\r\n    }\r\n\r\n    public canvas:Node;\r\n}\r\n"]}