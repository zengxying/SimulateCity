{"version":3,"sources":["file:///D:/cocos_work/games/SimulateCity/assets/src/component/OperateComp.ts"],"names":["_decorator","Component","Vec2","Vec3","Input","input","KeyCode","v2","misc","geometry","GlobalConst","ray","v2_1","v2_2","v2_3","v2_4","v3_1","v3_2","Msg","MsgEvent","Util","Log","CameraControllerComp","MapOperateComp","ccclass","property","OperateComp","rotaWheelSpeed","touchDir","keys","key2dirMap","onLoad","on","EventType","MOUSE_WHEEL","onMouseWheel","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","KEY_DOWN","onKeyDown","KEY_UP","onKeyUp","onDestroy","off","e","interruptOp","console","warn","log","getScrollX","getScrollY","delta","emit","OP_TOUCH_SCALE","touches","getAllTouches","test","getLocation","length","getPreviousLocation","disPre","distance","subtract","angle","radiansToDegrees","signAngle","preY","getDelta","y","curY","disCur","realAngle","getAngleBetweenVectors","scale","rota","set","OP_TOUCH_ROTA","x","camera","screenPointToRay","dis2","intersect","rayModel","ins","_meshRender","model","computeHit","lv","getScreenToWorld","z","OP_TOUCH_MOVE","getStartLocation","dis","event","keyCode","KEY_A","KEY_S","KEY_D","KEY_W","indexOf","push","updateDirection","KEY_Q","calculateRotaAxis","setRotaPos","KEY_E","cameraMoveDir","index","splice","keyCode0","keyCode1","dir"],"mappings":"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","sourcesContent":["import { _decorator, Component, Quat, Vec2, Vec3, Input, game, EventTouch, EventMouse, input, EventKeyboard, KeyCode, v2, misc, macro, geometry } from 'cc';\r\nimport { GlobalConst, ray, v2_1, v2_2, v2_3, v2_4, v3_1, v3_2 } from '../GlobalConst';\r\nimport { Msg } from '../msg/msg';\r\nimport { MsgEvent } from '../msg/MsgEvent';\r\nimport { Util } from '../framework/util';\r\nimport { Log } from '../framework/Log';\r\nimport { CameraControllerComp } from './CameraControllerComp';\r\nimport { MapOperateComp } from './MapOperateComp';\r\nconst { ccclass, property } = _decorator;\r\n\r\n\r\n\r\n/**\r\n * \r\n11.双指缩放，旋转  同时触发 也就是说有距离移动就缩放，有方向变化就旋转\r\n\r\n1.建造物的拖拽\r\n2.从ui拖出一个建筑物\r\n3.建造物各种状态的实时切换，不能放置，等\r\n\r\n4.滑动和点击的区分，用于建造时是切换建造物的位置还是移动视野\r\n5.长按建造物触发建筑物位置切换操作\r\n6.点击ui触发ui事件\r\n7.如果建造物的ui是3d的ui是否可用于触摸点击  或者是2d的ui怎么处理变化\r\n8.产出物品的拾取\r\n9.建造物升级添加材料的操作\r\n10.建筑物的回收操作\r\n12.玩家不同的操作对于3d世界的影响，各种颜色变换滤镜等\r\n(1)可支持的3d场景面数，精细度\t\t\r\n(2)选中房屋拖动时 房屋类型的建筑物会保持原有颜色，其他地图物体变换成灰色 这块的处理规则那就是保持个类型建造的引用封装处理，也可以实现倒是\r\n(3)各种建筑物的状态，生产，还是定时开启等\r\n */\r\n\r\n@ccclass('OperateComp')\r\nexport class OperateComp extends Component {\r\n\r\n    // 滚轮缩放的速度\r\n    rotaWheelSpeed: number = 0.1;\r\n\r\n\r\n    // 手指滑动方向\r\n    touchDir: Vec2 = new Vec2();\r\n\r\n    public onLoad() {\r\n        input.on(Input.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        input.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        input.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        input.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        input.on(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n\r\n\r\n        input.on(Input.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        input.on(Input.EventType.KEY_UP, this.onKeyUp, this);\r\n    }\r\n\r\n    public onDestroy() {\r\n        input.off(Input.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        input.off(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        input.off(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        input.off(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        input.off(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n\r\n        input.off(Input.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        input.off(Input.EventType.KEY_UP, this.onKeyUp, this);\r\n    }\r\n\r\n\r\n\r\n    public onMouseWheel(e: EventMouse) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n        console.log(`滚轮滚动的参数 getScrollX：${e.getScrollX()}  getScrollY:${e.getScrollY()}`)\r\n        const delta = -e.getScrollY() * this.rotaWheelSpeed * 0.1; // delta is positive when scroll down\r\n        Msg.emit(MsgEvent.OP_TOUCH_SCALE, delta);\r\n\r\n        // // // 将数据放出去\r\n        // Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this.node.rotation);\r\n        // Vec3.scaleAndAdd(this._position, this.node.position, v3_1, delta);\r\n    }\r\n\r\n    public onTouchStart(e: EventTouch) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n        // if (game.canvas.requestPointerLock) { game.canvas.requestPointerLock(); }\r\n        const touches = e.getAllTouches();\r\n\r\n        CameraControllerComp.test(e.getLocation());\r\n        if (touches.length > 1) {\r\n\r\n        } else {\r\n\r\n        }\r\n    }\r\n\r\n    public onTouchMove(e: EventTouch) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n        const touches = e.getAllTouches();\r\n        if (touches.length > 1) {\r\n\r\n            touches[0].getPreviousLocation(v2_1);\r\n            touches[1].getPreviousLocation(v2_2);\r\n\r\n\r\n            let disPre = Vec2.distance(v2_1, v2_2);\r\n            Vec2.subtract(v2_3, v2_2, v2_1);\r\n\r\n            touches[0].getPreviousLocation(v2_4).subtract(touches[1].getPreviousLocation(v2_1));\r\n            touches[0].getLocation(v2_1).subtract(touches[1].getLocation(v2_2));\r\n            let angle = misc.radiansToDegrees(v2_4.signAngle(v2_1));// y轴旋转\r\n\r\n            let preY = touches[0].getDelta(v2_2).y;\r\n            let curY = touches[1].getDelta(v2_1).y;\r\n\r\n            touches[0].getLocation(v2_1);\r\n            touches[1].getLocation(v2_2);\r\n            let disCur = Vec2.distance(v2_1, v2_2);\r\n            Vec2.subtract(v2_2, v2_2, v2_1);\r\n            let realAngle = Util.getAngleBetweenVectors(v2_3, v2_2);// y轴旋转\r\n\r\n            // let angle = 0;\r\n            let scale = 0;\r\n            let rota = 0;\r\n            // if (curY > 0 && preY > 0) {\r\n            //     angle = realAngle;\r\n            //     // rota = Math.min(curY, preY);\r\n            // } else if (curY < 0 && preY < 0) {\r\n            //     angle = realAngle;\r\n            //     // rota = Math.max(curY, preY);\r\n            // } else {\r\n            // }\r\n            scale = disPre - disCur;\r\n\r\n\r\n            v2_2.set(rota, angle);\r\n            Msg.emit(MsgEvent.OP_TOUCH_SCALE, scale * 0.1);\r\n            Msg.emit(MsgEvent.OP_TOUCH_ROTA, v2_2);\r\n            Log.log(\"on touch move:realAngle---> \", angle, v2_4.x, v2_4.y);\r\n        } else {\r\n            touches[0].getLocation(v2_2);\r\n            const camera = CameraControllerComp.camera;\r\n            camera.screenPointToRay(v2_2.x, v2_2.y, ray);\r\n            let dis2 = geometry.intersect.rayModel(ray, MapOperateComp.ins._meshRender.model);\r\n            if (dis2) {\r\n                ray.computeHit(v3_2, dis2); // 性能要好些\r\n            }\r\n\r\n\r\n            const lv = 0.05;\r\n            touches[0].getPreviousLocation(v2_1);\r\n            Util.getScreenToWorld(v2_1, v3_1, lv);\r\n\r\n\r\n            touches[0].getLocation(v2_2);\r\n            Util.getScreenToWorld(v2_2, v3_2, lv);\r\n\r\n            Vec3.subtract(v3_2, v3_1, v3_2);\r\n            v2_1.set(v3_2.x, v3_2.z);\r\n            e.getDelta(v2_2);\r\n            v2_2.y *= -1;\r\n\r\n\r\n            Msg.emit(MsgEvent.OP_TOUCH_MOVE, v2_1);\r\n\r\n            touches[0].getStartLocation(v2_1);\r\n            Util.getScreenToWorld(v2_1, v3_1, lv);\r\n\r\n\r\n            touches[0].getLocation(v2_2);\r\n            Util.getScreenToWorld(v2_2, v3_2, lv);\r\n\r\n            Vec3.subtract(v3_2, v3_1, v3_2);\r\n            let dis = Vec3.distance(v3_1, v3_2);\r\n            console.log(\"总的移动长度：----> \" + dis);\r\n        }\r\n        // if (v2_1.x > game.canvas.width * 0.4) { // rotation\r\n        //     e.getDelta(v2_2);\r\n        //     this._eulerP.y -= v2_2.x * this.rotateSpeed * 0.1;\r\n        //     this._eulerP.x += v2_2.y * this.rotateSpeed * 0.1;\r\n        // } else { // position\r\n        //     e.getDelta(v2_2);\r\n        //     this._eulerP.y -= v2_2.x * this.rotateSpeed * 0.1;\r\n        //     this._eulerP.x += v2_2.y * this.rotateSpeed * 0.1;\r\n        // }\r\n    }\r\n\r\n    public onTouchEnd(e: EventTouch) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n        // if (document.exitPointerLock) { document.exitPointerLock(); }\r\n        const touches = e.getAllTouches();\r\n        if (touches.length <= 1) {\r\n            Msg.emit(MsgEvent.OP_TOUCH_MOVE, v2_1.set(0, 0));\r\n        }\r\n    }\r\n\r\n    private keys = [];\r\n    // x  -1 left, +1 right   y -1 backword, +1 forward\r\n\r\n    onKeyDown(event: EventKeyboard) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n\r\n        let keyCode = event.keyCode;\r\n        if (keyCode == KeyCode.KEY_A || keyCode == KeyCode.KEY_S || keyCode == KeyCode.KEY_D || keyCode == KeyCode.KEY_W) {\r\n            if (this.keys.indexOf(keyCode) == -1) {\r\n                this.keys.push(keyCode);\r\n                this.updateDirection();\r\n            }\r\n        }\r\n        if (keyCode == KeyCode.KEY_Q) {\r\n            MapOperateComp.ins.calculateRotaAxis();\r\n            MapOperateComp.ins.setRotaPos(10);\r\n            // GlobalConst.cameraMoveDir.y = -1;\r\n        }\r\n        else if (keyCode == KeyCode.KEY_E) {\r\n            GlobalConst.cameraMoveDir.y = 1;\r\n        }\r\n    }\r\n\r\n    onKeyUp(event: EventKeyboard) {\r\n        if (GlobalConst.interruptOp) return console.warn(\"中断操作中...............\");\r\n\r\n        let keyCode = event.keyCode;\r\n        if (keyCode == KeyCode.KEY_A || keyCode == KeyCode.KEY_S || keyCode == KeyCode.KEY_D || keyCode == KeyCode.KEY_W) {\r\n            let index = this.keys.indexOf(keyCode);\r\n            if (index != -1) {\r\n                this.keys.splice(index, 1);\r\n                this.updateDirection();\r\n            }\r\n        }\r\n\r\n        if (keyCode == KeyCode.KEY_Q || keyCode == KeyCode.KEY_E) {\r\n            // GlobalConst.cameraMoveDir.y = 0;\r\n        }\r\n    }\r\n\r\n\r\n\r\n\r\n    private key2dirMap = null;\r\n\r\n    updateDirection() {\r\n        if (this.key2dirMap == null) {\r\n            this.key2dirMap = {};\r\n            this.key2dirMap[0] = v2(0, 0);\r\n            this.key2dirMap[KeyCode.KEY_A] = v2(-1, 0);\r\n            this.key2dirMap[KeyCode.KEY_D] = v2(1, 0);\r\n            this.key2dirMap[KeyCode.KEY_W] = v2(0, 1);\r\n            this.key2dirMap[KeyCode.KEY_S] = v2(0, -1);\r\n\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_A] = v2(-1, 1);\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_D] = v2(1, 1);\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_A] = v2(-1, -1);\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_D] = v2(1, -1);\r\n\r\n            this.key2dirMap[KeyCode.KEY_A * 1000 + KeyCode.KEY_D] = this.key2dirMap[KeyCode.KEY_D];\r\n            this.key2dirMap[KeyCode.KEY_D * 1000 + KeyCode.KEY_A] = this.key2dirMap[KeyCode.KEY_A];\r\n            this.key2dirMap[KeyCode.KEY_W * 1000 + KeyCode.KEY_S] = this.key2dirMap[KeyCode.KEY_S];\r\n            this.key2dirMap[KeyCode.KEY_S * 1000 + KeyCode.KEY_W] = this.key2dirMap[KeyCode.KEY_W];\r\n        }\r\n        let keyCode0 = this.keys[this.keys.length - 1] || 0;\r\n        let keyCode1 = this.keys[this.keys.length - 2] || 0;\r\n        let dir = this.key2dirMap[keyCode1 * 1000 + keyCode0];\r\n        GlobalConst.cameraMoveDir.x = dir.x;\r\n        GlobalConst.cameraMoveDir.z = dir.y;\r\n    }\r\n}\r\n"]}