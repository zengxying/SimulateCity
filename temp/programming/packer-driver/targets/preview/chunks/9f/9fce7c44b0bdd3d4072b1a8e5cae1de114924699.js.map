{"version":3,"sources":["file:///D:/cocos_work/games/SimulateCity/assets/src/component/CameraControllerComp.ts"],"names":["_decorator","CameraComponent","Component","Quat","Vec2","Vec3","GlobalConst","Msg","MsgEvent","Log","ccclass","property","v2_1","v2_2","v3_1","v3_2","qt_1","forward","right","CameraControllerComp","slide","range","_camera","_velocity","_position","_speedScale","_eulerP","distanceZ","onLoad","node","getComponentInChildren","copy","getPosition","eulerAngles","onEnable","on","OP_TOUCH_MOVE","moveView","bind","OP_TOUCH_ROTA","rotaView","OP_TOUCH_SCALE","scaleView","onDisable","off","start","set","screenToWorld","console","log","vec2","x","y","subtract","speed","Math","abs","z","transformQuat","UNIT_Z","rotation","scaleAndAdd","position","update","dt","t","min","damp","moveSpeed","lerp","setPosition","moveDir","cameraMoveDir","lengthSqr","FORWARD","normalize","cross","UP","fromEuler","slerp","setWorldRotationFromEuler"],"mappings":"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","sourcesContent":["import { _decorator, Camera, CameraComponent, Component, director, EventTouch, game, Node, Quat, sp, Vec2, Vec3 } from 'cc';\r\nimport { GlobalConst } from '../GlobalConst';\r\nimport { Msg } from '../msg/msg';\r\nimport { MsgEvent } from '../msg/MsgEvent';\r\nimport { Log } from '../framework/Log';\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst v2_1 = new Vec2();\r\nconst v2_2 = new Vec2();\r\n\r\nconst v3_1 = new Vec3();\r\nconst v3_2 = new Vec3();\r\nconst qt_1 = new Quat();\r\nconst forward = new Vec3();\r\nconst right = new Vec3();\r\n\r\n@ccclass('CameraControllerComp')\r\nexport class CameraControllerComp extends Component {\r\n\r\n    private _camera: CameraComponent;\r\n\r\n    @property\r\n    public moveSpeed = 1;\r\n\r\n    @property\r\n    public moveSpeedShiftScale = 5;\r\n\r\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\r\n    public damp = 0.2;\r\n\r\n    @property\r\n    public rotateSpeed = 1;\r\n\r\n    private _velocity = new Vec3();\r\n    private _position = new Vec3();\r\n    private _speedScale = 1;\r\n    private _eulerP = new Vec3();\r\n\r\n    distanceZ: number = 20;\r\n\r\n    // 移动  单指\r\n\r\n    // 旋转  双指\r\n    // 缩放\r\n\r\n    // 边界\r\n    // 数据区间\r\n\r\n    // 插值运算\r\n\r\n    protected onLoad(): void {\r\n        this._camera = this.node.getComponentInChildren(CameraComponent);\r\n        Vec3.copy(this._position, this.node.getPosition());\r\n        Vec3.copy(this._eulerP, this._camera.node.eulerAngles);\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        Msg.on(MsgEvent.OP_TOUCH_MOVE, this.moveView.bind(this));\r\n        Msg.on(MsgEvent.OP_TOUCH_ROTA, this.rotaView.bind(this));\r\n        Msg.on(MsgEvent.OP_TOUCH_SCALE, this.scaleView.bind(this));\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        Msg.off(MsgEvent.OP_TOUCH_MOVE);\r\n        Msg.off(MsgEvent.OP_TOUCH_ROTA);\r\n        Msg.off(MsgEvent.OP_TOUCH_SCALE);\r\n    }\r\n\r\n    start() {\r\n        v3_1.set();\r\n        this._camera.screenToWorld(v3_1, v3_1);\r\n        console.log(\"v3_1\",v3_1);\r\n    }\r\n\r\n\r\n    /** 移动 */\r\n    public moveView(vec2:Vec2) {\r\n        this._velocity.set(vec2.x, vec2.y, 0);\r\n        this._camera.screenToWorld(this._velocity,this._velocity);\r\n        Vec3.subtract(this._velocity, this._velocity, this._position);\r\n    }\r\n\r\n    /** 缩放 */\r\n    public scaleView(speed: number) {\r\n        Log.log(\"scaleView -- speed:\"+speed);\r\n        if(Math.abs(this._position.z + speed) < this.distanceZ){\r\n            Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this._camera.node.rotation);\r\n            Vec3.scaleAndAdd(this._position, this.node.position, v3_1, speed);\r\n        }\r\n    }\r\n\r\n    /** 旋转 */\r\n    public rotaView(vec2: Vec2) {\r\n        \r\n        let x = vec2.x;\r\n        let y = vec2.y;\r\n        if (this._eulerP.x + x < -30 && this._eulerP.x + x > -90) { // x处角度的旋转限制 测试使用\r\n            this._eulerP.x += x;\r\n        }\r\n        this._eulerP.y += y;\r\n    }\r\n\r\n    public update(dt: number) {\r\n        v3_1.set();\r\n        this._camera.screenToWorld(v3_1, v3_2);\r\n        console.log(\"v3_1\",v3_2);\r\n        const t = Math.min(dt / this.damp, 1);\r\n        // position\r\n        Vec3.transformQuat(v3_1, this._velocity, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this._position, v3_1, this.moveSpeed * this._speedScale);\r\n        Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n        this.node.setPosition(v3_1);\r\n        const moveDir = GlobalConst.cameraMoveDir;\r\n        if (moveDir.lengthSqr()) {\r\n            Vec3.transformQuat(forward, Vec3.FORWARD, this.node.rotation);\r\n            forward.normalize();\r\n            Vec3.cross(right, forward, Vec3.UP);\r\n            right.normalize();\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, forward, this.moveSpeed * this._speedScale * moveDir.z);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, right, this.moveSpeed * this._speedScale * moveDir.x);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n\r\n            Vec3.scaleAndAdd(this._position, this._position, Vec3.UP, this.moveSpeed * this._speedScale * moveDir.y);\r\n            Vec3.lerp(v3_1, this.node.getPosition(), this._position, t);\r\n            this.node.setPosition(v3_1);\r\n        }\r\n\r\n        // rotation\r\n        Quat.fromEuler(qt_1, this._eulerP.x, this._eulerP.y, this._eulerP.z);\r\n        Quat.slerp(qt_1, this.node.rotation, qt_1, t);\r\n        this._camera.node.setWorldRotationFromEuler(this._eulerP.x, this._eulerP.y, this._eulerP.z);\r\n        this._velocity.set();\r\n    }\r\n}\r\n\r\n\r\n"]}