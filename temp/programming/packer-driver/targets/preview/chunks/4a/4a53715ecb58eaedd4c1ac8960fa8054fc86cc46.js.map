{"version":3,"sources":["file:///D:/cocos_work/SimulateCity/assets/src/MapMgr.ts"],"names":["MapMgr","MeshRenderer","Quat","Vec3","geometry","GlobalConst","ray","v3_1","worldMatrix","qt_1","mapHitPoint","constructor","_node","_meshRender","ins","_ins","node","mapPanel","getComponent","calculateHitPoint","vec2","out","camera","screenPointToRay","x","y","dis","intersect","rayModel","model","computeHit","set","getHitPointToGrid","inverseTransformPoint","scale","scaleX","mapGridWidth","scaleY","mapGridHeight","z","Math","floor","getHitPointToGridPosition","outGrid","_setMapPos","getWorldMatrix","transformMat4"],"mappings":"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","sourcesContent":["import { MeshRenderer, Node, Quat, Vec2, Vec3, geometry } from \"cc\";\r\nimport { GlobalConst, ray, v3_1, worldMatrix } from \"./GlobalConst\";\r\n\r\n\r\nconst qt_1 = new Quat();\r\nconst mapHitPoint: Vec3 = new Vec3();\r\n\r\nexport class MapMgr{\r\n\r\n    // 地图块的计算，当前地图有多少格子，那些格子可用\r\n    // 当前地图存在的建筑物\r\n    // 建筑物对应的状态\r\n    // 各个建筑物的状态更新\r\n    _node:Node;\r\n    _meshRender:MeshRenderer;\r\n    constructor(){\r\n        \r\n    }\r\n\r\n\r\n    private static _ins:MapMgr;\r\n    public static get ins(){\r\n        return this._ins ||= new MapMgr();\r\n    }\r\n\r\n\r\n    public get node(){\r\n        this._node ||= GlobalConst.mapPanel\r\n        if(! this._meshRender){\r\n            this._meshRender = this._node.getComponent(MeshRenderer);\r\n        }\r\n        return this._node;\r\n    }\r\n    \r\n    /** 计算触发到地图上的点位, 传入屏幕坐标 */\r\n    public calculateHitPoint(vec2: Vec2, out?: Vec3) {\r\n        if(! this._node) this.node;\r\n        const camera = GlobalConst.camera;\r\n        camera.screenPointToRay(vec2.x, vec2.y, ray);\r\n        let dis = geometry.intersect.rayModel(ray, this._meshRender.model);\r\n        if (dis) {\r\n            ray.computeHit(mapHitPoint, dis); // 性能要好些\r\n            out && out.set(mapHitPoint);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /** 获取点击的格子, 传入屏幕坐标*/\r\n    public getHitPointToGrid(vec2: Vec2, out: Vec2) {\r\n        if (this.calculateHitPoint(vec2)) {\r\n            this.node.inverseTransformPoint(v3_1, mapHitPoint);\r\n            const scale = this.node.scale;\r\n            let scaleX = GlobalConst.mapGridWidth / scale.x;\r\n            let scaleY = GlobalConst.mapGridHeight / scale.z;\r\n\r\n            out.x = Math.floor(v3_1.x / scaleX);\r\n            out.y = Math.floor(v3_1.z / scaleY);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /** 获取点击的格子中心坐标, 传入屏幕坐标 */\r\n    public getHitPointToGridPosition(vec2: Vec2, out: Vec3, outGrid:Vec2) {\r\n        if (this.calculateHitPoint(vec2)) {\r\n            this._setMapPos(out,outGrid);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    private _setMapPos(out: Vec3,outGrid:Vec2) {\r\n        this.node.inverseTransformPoint(v3_1, mapHitPoint);\r\n        const scale = this.node.scale;\r\n        let scaleX = GlobalConst.mapGridWidth / scale.x;\r\n        let scaleY = GlobalConst.mapGridHeight / scale.z;\r\n        \r\n        outGrid.x = Math.floor(v3_1.x / scaleX);\r\n        outGrid.y = Math.floor(v3_1.z / scaleY);\r\n\r\n        out.x = (outGrid.x + 0.5) * scaleX;\r\n        out.y = out.y;\r\n        out.z = (outGrid.y + 0.5) * scaleY;\r\n\r\n        this.node.getWorldMatrix(worldMatrix);\r\n        Vec3.transformMat4(out, out, worldMatrix);\r\n    }\r\n}"]}